# هيكلية نظام HelpDesk (System Architecture)

هذا المستند يوضح الهيكلية التقنية لمنصة الخدمات الموحدة وكيفية عمل المحركات الرئيسية.

## 1. محرك سير العمل (Workflow Engine)
يعتمد النظام على محرك "حالات" متطور يدعم المسارات المتوازية والشرطية.

### مسارات العمل المتوازية (Parallel Workflows)
- يتم تتبع الخطوات النشطة في جدول `request_active_steps`.
- الانتقال بين الخطوات يتم عبر `src/lib/workflow-engine.ts`.
- **ملاحظة:** تم الانتقال من استخدام `current_step_id` (بسيط) إلى `request_active_steps` لدعم تشغيل أكثر من اعتماد في آن واحد.

### حل المسؤولين (Assignee Resolution)
يستخدم النظام `resolveStepAssignee` في `src/lib/workflow-resolver.ts` لتحديد من يجب أن يقوم بالخطوة التالية:
- **الأدوار الثابتة:** مثل `admin` أو `hr_specialist`.
- **الأدوار الديناميكية (Manager Chain):** 
    - `DIRECT_MANAGER`: المدير المباشر لمقدم الطلب.
    - `MANAGER_LEVEL_2`: مدير المدير، وهكذا.
    - يتم جلب هذه البيانات من جدول `users` عبر حقل `direct_manager_id`.

## 2. محرك النماذج (Form Engine)
- يتم تعريف الحقول لكل خدمة في حقل `form_schema` (JSON0 في جدول `services`).
- عند تقديم الطلب، يتم أخذ لقطة (Snapshot) من النموذج وحفظها في `requests.form_schema_snapshot` لضمان استقرار البيانات حتى لو تم تعديل الخدمة لاحقاً.

## 3. نظام الإشعارات (Notifications)
- يتم إنشاء الإشعارات عبر `src/lib/notifications.ts`.
- يستخدم النظام `RPC` في Supabase لإنشاء الإشعارات لتجاوز قيود الصلاحيات (RLS) وضمان وصول التنبيهات للمستخدمين المستهدفين.

## 4. جداول قاعدة البيانات الرئيسية
| الجدول | الوصف |
| :--- | :--- |
| `services` | تعريف الخدمة، النماذج، والإعدادات العامة. |
| `workflows` | تعريف مسارات العمل (Nodes & Edges). |
| `requests` | الطلبات المقدمة وحالتها الحالية. |
| `workflow_tasks` | المهام الفردية الموكلة لموظفين معينين. |
| `request_active_steps` | تتبع الخطوات النشطة في محرك سير العمل. |
| `step_field_permissions` | التحكم في ظهور وتعديل الحقول لكل خطوة. |

---
تم التحديث: ديسمبر 2025
